{% extends "base.html" %}

{% block title %}AI & LLM Settings - HuduGlue{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">AI & LLM Settings</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Settings</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'core:settings_general' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-sliders-h"></i> General
                </a>
                <a href="{% url 'core:settings_security' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-shield-alt"></i> Security
                </a>
                <a href="{% url 'core:settings_smtp' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-envelope"></i> SMTP/Email
                </a>
                <a href="{% url 'core:settings_scheduler' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-clock"></i> Task Scheduler
                </a>
                <a href="{% url 'core:settings_directory' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-users-cog"></i> Directory Services
                </a>
                <a href="{% url 'core:settings_ai' %}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-robot"></i> AI & LLM
                </a>
                <a href="{% url 'core:system_status' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-heartbeat"></i> System Status
                </a>
                <a href="{% url 'core:maintenance' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-tools"></i> Maintenance
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-robot"></i> AI & LLM Settings</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>About AI Floor Plan Generation:</strong> HuduGlue uses Claude AI to intelligently design office floor plans based on building dimensions, employee count, departments, and network requirements. The AI analyzes your specifications and generates professional Draw.io diagrams with proper room layouts, network infrastructure, and security systems.
                </div>

                <form method="post">
                    {% csrf_token %}

                    <h5 class="mb-3">Anthropic (Claude AI)</h5>

                    <div class="mb-3">
                        <label for="anthropic_api_key" class="form-label">Anthropic API Key</label>
                        <input type="password" class="form-control font-monospace" id="anthropic_api_key" name="anthropic_api_key" value="{{ current_anthropic_key }}" placeholder="sk-ant-api03-...">
                        <div class="form-text">
                            Required for AI floor plan generation. Get your API key at <a href="https://console.anthropic.com/" target="_blank">console.anthropic.com</a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="claude_model" class="form-label">Claude Model</label>
                        <select class="form-select" id="claude_model" name="claude_model">
                            <option value="claude-opus-4-5-20251101" {% if current_claude_model == 'claude-opus-4-5-20251101' %}selected{% endif %}>Claude Opus 4.5 (Most Capable)</option>
                            <option value="claude-sonnet-4-5-20250929" {% if current_claude_model == 'claude-sonnet-4-5-20250929' %}selected{% endif %}>Claude Sonnet 4.5 (Balanced - Recommended)</option>
                            <option value="claude-3-5-sonnet-20241022" {% if current_claude_model == 'claude-3-5-sonnet-20241022' %}selected{% endif %}>Claude 3.5 Sonnet (Legacy)</option>
                            <option value="claude-3-5-haiku-20241022" {% if current_claude_model == 'claude-3-5-haiku-20241022' %}selected{% endif %}>Claude 3.5 Haiku (Fastest, Lower Cost)</option>
                        </select>
                        <div class="form-text">
                            Choose the Claude model for floor plan generation. Sonnet 4.5 offers the best balance of quality and cost.
                        </div>
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3">Mapping & Geocoding (Optional)</h5>

                    <div class="mb-3">
                        <label for="google_maps_api_key" class="form-label">Google Maps API Key</label>
                        <input type="password" class="form-control font-monospace" id="google_maps_api_key" name="google_maps_api_key" value="{{ current_google_maps_key }}" placeholder="AIza...">
                        <div class="form-text">
                            Optional. Used for geocoding addresses and fetching satellite imagery.
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Important: Google Maps Setup Instructions</strong>
                        <p class="mb-2 mt-2">You need <strong>ONE API key</strong> but must enable <strong>4 different APIs</strong> in your Google Cloud project:</p>
                        <ol class="mb-2 small">
                            <li><strong>Create/Select Project:</strong> Go to <a href="https://console.cloud.google.com/" target="_blank" class="alert-link">Google Cloud Console</a> and select or create a project</li>
                            <li><strong>Enable these 4 APIs</strong> (go to <a href="https://console.cloud.google.com/apis/library" target="_blank" class="alert-link">API Library</a>, search for each, and click "Enable"):
                                <ul class="mt-1">
                                    <li><strong>Maps Embed API</strong> - For interactive maps</li>
                                    <li><strong>Maps Static API</strong> - For satellite imagery</li>
                                    <li><strong>Geocoding API</strong> - For address to coordinates conversion</li>
                                    <li><strong>Places API (New)</strong> - For property data lookup</li>
                                </ul>
                            </li>
                            <li><strong>Create ONE API Key:</strong> <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="alert-link">Credentials</a> → "Create Credentials" → "API Key"</li>
                            <li><strong>Copy the single API key</strong> and paste it above. This one key works for all enabled APIs.</li>
                        </ol>
                        <p class="mb-1 small"><strong>Important:</strong> You don't need separate keys for each API - just ONE key with all APIs enabled!</p>
                        <p class="mb-0 small"><strong>Billing:</strong> Each API has a generous free tier. Google requires a billing account but won't charge unless you exceed free limits (unlikely for typical usage).</p>
                    </div>

                    <hr class="my-4">

                    <h5 class="mb-3">Property Data APIs (Optional)</h5>

                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <strong>Free Option Available!</strong> HuduGlue now automatically tries municipal tax collector records (public property data) when you click "Auto-Refresh" on location pages.
                        <strong>No configuration needed</strong> - works for Florida counties and many other US jurisdictions.
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Premium Services (Below):</strong> These paid APIs provide comprehensive building information beyond what's available in public records.
                        <strong>Not required</strong> - you can use free municipal data or manually enter building information.
                    </div>

                    <div class="mb-3">
                        <label for="regrid_api_key" class="form-label">Regrid API Key</label>
                        <input type="password" class="form-control font-monospace" id="regrid_api_key" name="regrid_api_key" value="{{ current_regrid_key }}" placeholder="Leave blank if not using">
                        <div class="form-text">
                            Optional. Provides property/parcel data. <a href="https://regrid.com/pricing" target="_blank">Starting at $299/month</a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="attom_api_key" class="form-label">AttomData API Key</label>
                        <input type="password" class="form-control font-monospace" id="attom_api_key" name="attom_api_key" value="{{ current_attom_key }}" placeholder="Leave blank if not using">
                        <div class="form-text">
                            Optional. Provides property details and valuations. <a href="https://www.attomdata.com/solutions/" target="_blank">Contact for pricing</a>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Automatic Restart:</strong> When you save settings, the application will automatically restart to apply the new API keys. This takes about 2-3 seconds.
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            Changes are saved to .env file
                        </small>
                        <button type="submit" class="btn btn-primary" id="saveSettingsBtn">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </form>

                <hr class="my-4">

                <h5 class="mb-3">Usage Information</h5>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Required API</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>AI Floor Plan Generation</td>
                                <td>Anthropic Claude</td>
                                <td>
                                    {% if current_anthropic_key %}
                                    <span class="badge bg-success">Configured</span>
                                    {% else %}
                                    <span class="badge bg-warning">Not Configured</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Address Geocoding</td>
                                <td>Google Maps</td>
                                <td>
                                    {% if current_google_maps_key %}
                                    <span class="badge bg-success">Configured</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Optional</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Satellite Imagery</td>
                                <td>Google Maps</td>
                                <td>
                                    {% if current_google_maps_key %}
                                    <span class="badge bg-success">Configured</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Optional</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="card bg-light mt-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-lightbulb"></i> Cost Estimates</h6>
                        <p class="card-text small mb-2">
                            <strong>Claude Sonnet 4.5:</strong> ~$0.03-0.10 per floor plan<br>
                            <strong>Claude Opus 4.5:</strong> ~$0.15-0.30 per floor plan<br>
                            <strong>Claude Haiku 3.5:</strong> ~$0.01-0.03 per floor plan
                        </p>
                        <p class="card-text small text-muted mb-0">
                            Actual costs depend on building complexity and requirements. Most office floor plans use 500-2000 tokens.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Restart Loading Overlay -->
<div id="restartOverlay" class="restart-overlay" style="display: none;">
    <div class="restart-modal">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="text-primary mb-2">Now restarting services...</h4>
        <p class="text-muted mb-0">Applying your API key changes</p>
        <div class="progress mt-3" style="height: 4px; width: 250px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
        </div>
    </div>
</div>

<style>
.restart-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-in-out;
}

.restart-modal {
    background: white;
    padding: 40px 60px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    animation: slideUp 0.4s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@keyframes slideUp {
    from {
        transform: translateY(30px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Dark theme support */
[data-bs-theme="dark"] .restart-modal {
    background: #2d3748;
    color: #e2e8f0;
}

[data-bs-theme="dark"] .restart-modal h4 {
    color: #90cdf4 !important;
}

[data-bs-theme="dark"] .restart-modal .text-muted {
    color: #a0aec0 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const overlay = document.getElementById('restartOverlay');
    const saveBtn = document.getElementById('saveSettingsBtn');

    form.addEventListener('submit', function(e) {
        // Show the restart overlay
        overlay.style.display = 'flex';

        // Disable the save button to prevent double submission
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        // The form will submit normally, and the page will reload after restart
        // If the reload takes longer than expected, show a message
        setTimeout(function() {
            if (overlay.style.display !== 'none') {
                // Still waiting after 10 seconds - add a message
                const modal = document.querySelector('.restart-modal p');
                modal.innerHTML = 'Taking longer than expected. Please wait...<br><small>If this continues, refresh the page manually.</small>';
            }
        }, 10000);
    });
});
</script>

{% endblock %}
