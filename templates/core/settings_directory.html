{% extends "base.html" %}

{% block title %}Directory Services - HuduGlue{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
        <li class="breadcrumb-item active">Directory Services</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-cog"></i> Settings</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'core:settings_general' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-sliders-h"></i> General
                </a>
                <a href="{% url 'core:settings_security' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-shield-alt"></i> Security
                </a>
                <a href="{% url 'core:settings_smtp' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-envelope"></i> SMTP/Email
                </a>
                <a href="{% url 'core:settings_scheduler' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-clock"></i> Task Scheduler
                </a>
                <a href="{% url 'core:settings_directory' %}" class="list-group-item list-group-item-action active">
                    <i class="fas fa-users-cog"></i> Directory Services
                </a>
                <a href="{% url 'core:settings_ai' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-robot"></i> AI & LLM
                </a>
                <a href="{% url 'core:system_status' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-heartbeat"></i> System Status
                </a>
                <a href="{% url 'core:maintenance' %}" class="list-group-item list-group-item-action">
                    <i class="fas fa-tools"></i> Maintenance
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-users-cog"></i> Directory Services</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Configure LDAP/Active Directory or Azure AD for centralized user management.</p>

                <form method="post">
                    {% csrf_token %}

                    <!-- LDAP/Active Directory Section -->
                    <h5 class="mt-4 mb-3"><i class="fas fa-sitemap"></i> LDAP / Active Directory</h5>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="ldap_enabled" name="ldap_enabled"
                               {% if settings.ldap_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="ldap_enabled">
                            <strong>Enable LDAP/Active Directory</strong>
                        </label>
                    </div>

                    <div id="ldapSettings" {% if not settings.ldap_enabled %}style="display:none"{% endif %}>
                        <div class="mb-3">
                            <label for="ldap_server_uri" class="form-label">Server URI *</label>
                            <input type="text" class="form-control" id="ldap_server_uri" name="ldap_server_uri"
                                   value="{{ settings.ldap_server_uri }}"
                                   placeholder="ldap://dc.example.com:389">
                            <div class="form-text">LDAP server URI (ldap:// or ldaps://)</div>
                        </div>

                        <div class="mb-3">
                            <label for="ldap_bind_dn" class="form-label">Bind DN *</label>
                            <input type="text" class="form-control" id="ldap_bind_dn" name="ldap_bind_dn"
                                   value="{{ settings.ldap_bind_dn }}"
                                   placeholder="CN=ServiceAccount,OU=Users,DC=example,DC=com">
                            <div class="form-text">Service account DN for LDAP queries</div>
                        </div>

                        <div class="mb-3">
                            <label for="ldap_bind_password" class="form-label">Bind Password</label>
                            <input type="password" class="form-control" id="ldap_bind_password" name="ldap_bind_password"
                                   placeholder="Leave blank to keep current password">
                            <div class="form-text">Password for bind DN (stored encrypted)</div>
                        </div>

                        <div class="mb-3">
                            <label for="ldap_user_search_base" class="form-label">User Search Base *</label>
                            <input type="text" class="form-control" id="ldap_user_search_base" name="ldap_user_search_base"
                                   value="{{ settings.ldap_user_search_base }}"
                                   placeholder="OU=Users,DC=example,DC=com">
                            <div class="form-text">Base DN for user searches</div>
                        </div>

                        <div class="mb-3">
                            <label for="ldap_user_search_filter" class="form-label">User Search Filter</label>
                            <input type="text" class="form-control" id="ldap_user_search_filter" name="ldap_user_search_filter"
                                   value="{{ settings.ldap_user_search_filter }}">
                            <div class="form-text">LDAP filter for user lookups (use %(user)s for username)</div>
                        </div>

                        <div class="mb-3">
                            <label for="ldap_group_search_base" class="form-label">Group Search Base (Optional)</label>
                            <input type="text" class="form-control" id="ldap_group_search_base" name="ldap_group_search_base"
                                   value="{{ settings.ldap_group_search_base }}"
                                   placeholder="OU=Groups,DC=example,DC=com">
                            <div class="form-text">Base DN for group searches</div>
                        </div>

                        <div class="mb-3">
                            <label for="ldap_require_group" class="form-label">Require Group (Optional)</label>
                            <input type="text" class="form-control" id="ldap_require_group" name="ldap_require_group"
                                   value="{{ settings.ldap_require_group }}"
                                   placeholder="CN=HuduGlueUsers,OU=Groups,DC=example,DC=com">
                            <div class="form-text">Only allow login if user is member of this group (full DN)</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="ldap_start_tls" name="ldap_start_tls"
                                   {% if settings.ldap_start_tls %}checked{% endif %}>
                            <label class="form-check-label" for="ldap_start_tls">
                                Use StartTLS for secure connection
                            </label>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Azure AD Section -->
                    <h5 class="mt-4 mb-3"><i class="fab fa-microsoft"></i> Azure AD / Microsoft Entra ID</h5>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="azure_ad_enabled" name="azure_ad_enabled"
                               {% if settings.azure_ad_enabled %}checked{% endif %}>
                        <label class="form-check-label" for="azure_ad_enabled">
                            <strong>Enable Azure AD / Microsoft Entra ID</strong>
                        </label>
                    </div>

                    <div id="azureSettings" {% if not settings.azure_ad_enabled %}style="display:none"{% endif %}>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Azure AD SSO Setup Instructions</strong>
                            <hr>
                            <h6 class="mt-3 mb-2">1. Register Application in Azure Portal</h6>
                            <ul class="small">
                                <li>Go to <a href="https://portal.azure.com" target="_blank" rel="noopener">Azure Portal</a> → Azure Active Directory → App registrations</li>
                                <li>Click <strong>New registration</strong></li>
                                <li>Name: <code>HuduGlue</code></li>
                                <li>Supported account types: <strong>Accounts in this organizational directory only</strong></li>
                                <li>Redirect URI: Web → <code>{{ request.scheme }}://{{ request.get_host }}/accounts/auth/azure/callback/</code></li>
                                <li>Click <strong>Register</strong></li>
                            </ul>

                            <h6 class="mb-2">2. Copy Application Details</h6>
                            <ul class="small">
                                <li><strong>Application (client) ID</strong> - Found on Overview page</li>
                                <li><strong>Directory (tenant) ID</strong> - Found on Overview page</li>
                            </ul>

                            <h6 class="mb-2">3. Create Client Secret</h6>
                            <ul class="small">
                                <li>Go to <strong>Certificates & secrets</strong> → <strong>Client secrets</strong></li>
                                <li>Click <strong>New client secret</strong></li>
                                <li>Description: <code>HuduGlue OAuth</code></li>
                                <li>Expiration: <strong>24 months</strong> (recommended)</li>
                                <li><strong>⚠️ IMPORTANT:</strong> Copy the <strong>Value</strong> immediately (you won't be able to see it again!)</li>
                            </ul>

                            <h6 class="mb-2">4. Configure API Permissions</h6>
                            <ul class="small">
                                <li>Go to <strong>API permissions</strong></li>
                                <li>Verify <strong>User.Read</strong> permission is present (added automatically)</li>
                                <li>If you have admin rights, click <strong>Grant admin consent</strong></li>
                            </ul>

                            <h6 class="mb-2">5. Configure Settings Below</h6>
                            <ul class="small">
                                <li>Enter the <strong>Tenant ID</strong>, <strong>Client ID</strong>, and <strong>Client Secret</strong> you copied</li>
                                <li>Redirect URI should be: <code>{{ request.scheme }}://{{ request.get_host }}/accounts/auth/azure/callback/</code></li>
                                <li>Enable <strong>Auto-create users</strong> to automatically create accounts for new Azure AD users</li>
                                <li>Click <strong>Save Changes</strong> below</li>
                            </ul>

                            <div class="alert alert-warning mt-2 mb-0">
                                <i class="fas fa-exclamation-triangle"></i> <strong>Note:</strong> Users authenticating via Azure AD will bypass 2FA requirements (Azure SSO is already secure). A "Sign in with Microsoft" button will appear on the login page once configured.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="azure_ad_tenant_id" class="form-label">Tenant ID *</label>
                            <input type="text" class="form-control" id="azure_ad_tenant_id" name="azure_ad_tenant_id"
                                   value="{{ settings.azure_ad_tenant_id }}"
                                   placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            <div class="form-text">Azure AD Tenant ID (GUID format)</div>
                        </div>

                        <div class="mb-3">
                            <label for="azure_ad_client_id" class="form-label">Application (Client) ID *</label>
                            <input type="text" class="form-control" id="azure_ad_client_id" name="azure_ad_client_id"
                                   value="{{ settings.azure_ad_client_id }}"
                                   placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">
                            <div class="form-text">Application (client) ID from Azure portal</div>
                        </div>

                        <div class="mb-3">
                            <label for="azure_ad_client_secret" class="form-label">Client Secret</label>
                            <input type="password" class="form-control" id="azure_ad_client_secret" name="azure_ad_client_secret"
                                   placeholder="Leave blank to keep current secret">
                            <div class="form-text">Client secret value (stored encrypted)</div>
                        </div>

                        <div class="mb-3">
                            <label for="azure_ad_redirect_uri" class="form-label">Redirect URI *</label>
                            <input type="text" class="form-control" id="azure_ad_redirect_uri" name="azure_ad_redirect_uri"
                                   value="{{ settings.azure_ad_redirect_uri|default:'' }}"
                                   placeholder="{{ request.scheme }}://{{ request.get_host }}/accounts/auth/azure/callback/">
                            <div class="form-text">Must match the redirect URI configured in Azure (typically: <code>{{ request.scheme }}://{{ request.get_host }}/accounts/auth/azure/callback/</code>)</div>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="azure_ad_auto_create_users" name="azure_ad_auto_create_users"
                                   {% if settings.azure_ad_auto_create_users %}checked{% endif %}>
                            <label class="form-check-label" for="azure_ad_auto_create_users">
                                Automatically create users on first Azure AD login
                            </label>
                        </div>

                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="azure_ad_sync_groups" name="azure_ad_sync_groups"
                                   {% if settings.azure_ad_sync_groups %}checked{% endif %}>
                            <label class="form-check-label" for="azure_ad_sync_groups">
                                Sync Azure AD groups to roles
                            </label>
                            <div class="form-text">Map Azure AD groups to HuduGlue roles</div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Directory Services Ready:</strong> All required Python packages (python-ldap, django-auth-ldap, msal, requests-oauthlib) are included in requirements.txt and automatically installed during setup.
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            {% if settings.updated_at %}
                            Last updated: {{ settings.updated_at }}
                            {% if settings.updated_by %}
                            by {{ settings.updated_by.username }}
                            {% endif %}
                            {% endif %}
                        </small>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Toggle LDAP settings visibility
document.getElementById('ldap_enabled').addEventListener('change', function() {
    document.getElementById('ldapSettings').style.display = this.checked ? 'block' : 'none';
});

// Toggle Azure AD settings visibility
document.getElementById('azure_ad_enabled').addEventListener('change', function() {
    document.getElementById('azureSettings').style.display = this.checked ? 'block' : 'none';
});
</script>
{% endblock %}
