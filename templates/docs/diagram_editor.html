{% extends "base.html" %}

{% block title %}Edit Diagram - {{ diagram.title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h4><i class="fas fa-edit"></i> Editing: {{ diagram.title }}</h4>
    <div>
        <button id="saveBtn" class="btn btn-success btn-sm" disabled>
            <i class="fas fa-save"></i> Save
        </button>
        <a href="{% url 'docs:diagram_detail' diagram.slug %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-times"></i> Close
        </a>
    </div>
</div>

<div class="alert alert-info alert-dismissible fade show mb-2" role="alert">
    <i class="fas fa-info-circle"></i> <strong>Draw.io Editor</strong> - Make your changes, then click Save. Auto-save every 60 seconds.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Draw.io iframe -->
<div class="card border-0">
    <div class="card-body p-0">
        <iframe
            id="drawio-iframe"
            src="https://embed.diagrams.net/?embed=1&proto=json&spin=1&saveAndExit=0&noSaveBtn=1&ui=kennedy&libraries=1&noExitBtn=1&autosave=1"
            style="width: 100%; height: 85vh; border: none;"
            allow="camera; microphone; clipboard-read; clipboard-write"
            sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups"
            allowfullscreen>
        </iframe>
    </div>
</div>

<!-- Store diagram XML in a script tag to avoid escaping issues -->
<script id="diagram-data" type="application/json">
{{ diagram.diagram_xml|default:""|safe }}
</script>

<div id="status" class="text-center text-muted small mt-2">
    Loading editor...
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const iframe = document.getElementById('drawio-iframe');
    const saveBtn = document.getElementById('saveBtn');
    const statusDiv = document.getElementById('status');
    const origin = 'https://embed.diagrams.net';

    // Get diagram XML from the script tag
    const diagramDataEl = document.getElementById('diagram-data');
    let currentDiagramXml = diagramDataEl ? diagramDataEl.textContent.trim() : '';
    let hasUnsavedChanges = false;
    let editorReady = false;
    let autoSaveInterval = null;

    // Update status message
    function updateStatus(message, isError = false) {
        statusDiv.textContent = message;
        statusDiv.className = `text-center small mt-2 ${isError ? 'text-danger' : 'text-muted'}`;
    }

    // Send message to draw.io iframe
    function sendToDrawio(action, data = {}) {
        const message = JSON.stringify({action, ...data});
        console.log('Sending to draw.io:', action, data);
        iframe.contentWindow.postMessage(message, origin);
    }

    // Save diagram via AJAX
    function saveDiagram(forceSave = false) {
        console.log('saveDiagram() called, forceSave:', forceSave, 'hasUnsavedChanges:', hasUnsavedChanges, 'xml length:', currentDiagramXml.length);

        if (!forceSave && !hasUnsavedChanges) {
            console.log('No changes to save, aborting');
            updateStatus('No changes to save');
            return;
        }

        if (!currentDiagramXml || currentDiagramXml.length === 0) {
            console.error('No diagram XML to save');
            updateStatus('Error: No diagram data', true);
            return;
        }

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        updateStatus('Saving...');
        console.log('Sending AJAX request to save diagram...');

        fetch('{% url "docs:diagram_save" diagram.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                diagram_xml: currentDiagramXml
            })
        })
        .then(response => {
            console.log('Save response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Save response data:', data);
            if (data.success) {
                hasUnsavedChanges = false;
                updateStatus(`Saved successfully (v${data.version})`);
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
                console.log('Diagram saved successfully, version:', data.version);
                console.log('hasUnsavedChanges set to false, save button disabled');

                // Re-enable button but show "Saved" for a moment
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                    // Keep button disabled until actual changes are made
                    console.log('Button text reset to Save');
                }, 2000);
            } else {
                throw new Error(data.error || 'Save failed');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            updateStatus('Error: ' + error.message, true);
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
        });
    }

    // Check if iframe loaded
    iframe.addEventListener('load', function() {
        console.log('Draw.io iframe loaded successfully');
        updateStatus('Editor loading...');
    });

    iframe.addEventListener('error', function() {
        console.error('Draw.io iframe failed to load');
        updateStatus('Failed to load editor iframe', true);
    });

    // Timeout to detect if editor never loads
    const loadTimeout = setTimeout(() => {
        if (!editorReady) {
            updateStatus('Editor failed to load. Please refresh the page or check console for errors.', true);
            console.error('Draw.io editor timeout - no init message received after 15 seconds');
            console.log('Check browser console for CORS or CSP errors');
        }
    }, 15000); // 15 second timeout

    // Handle messages from draw.io
    window.addEventListener('message', function(evt) {
        if (evt.origin !== origin) return;

        let msg;
        try {
            msg = JSON.parse(evt.data);
        } catch (e) {
            return;
        }

        console.log('Draw.io message:', msg.event);

        switch (msg.event) {
            case 'init':
                clearTimeout(loadTimeout);
                editorReady = true;
                console.log('Editor ready, diagram XML length:', currentDiagramXml.length);
                updateStatus('Editor ready');

                // Enable save button now that editor is ready
                saveBtn.disabled = false;
                console.log('Save button enabled (editor ready)');

                // Load existing diagram if available, otherwise load blank diagram
                if (currentDiagramXml && currentDiagramXml.length > 0) {
                    console.log('Loading existing diagram...');
                    sendToDrawio('load', {xml: currentDiagramXml});
                    updateStatus('Loading diagram...');
                } else {
                    console.log('No existing diagram, loading blank canvas...');
                    // Load a blank diagram to start the editor
                    const blankDiagram = '<mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel>';
                    sendToDrawio('load', {xml: blankDiagram});
                    updateStatus('Ready to draw');
                }

                // Start auto-save
                autoSaveInterval = setInterval(() => {
                    if (hasUnsavedChanges) {
                        sendToDrawio('export', {format: 'xml'});
                    }
                }, 60000); // Auto-save every 60 seconds
                break;

            case 'load':
                console.log('Diagram loaded event received');
                updateStatus('Diagram loaded');
                break;

            case 'autosave':
                // Diagram changed - this fires whenever user makes a change
                console.log('Autosave event received, xml length:', msg.xml ? msg.xml.length : 0);
                if (msg.xml) {
                    // Only mark as changed if XML actually changed (not just initial load)
                    if (msg.xml !== currentDiagramXml) {
                        console.log('XML changed, marking as unsaved');
                        currentDiagramXml = msg.xml;
                        hasUnsavedChanges = true;
                        saveBtn.disabled = false;
                        updateStatus('Unsaved changes');
                    } else {
                        console.log('XML unchanged, ignoring autosave event');
                    }
                } else {
                    console.warn('Autosave event missing xml data');
                }
                break;

            case 'save':
                // User clicked internal save (Ctrl+S or File > Save in draw.io)
                console.log('Save event received from draw.io');
                if (msg.xml) {
                    currentDiagramXml = msg.xml;
                    hasUnsavedChanges = true;
                    saveDiagram(true); // Force save
                } else {
                    console.warn('Save event missing xml data');
                }
                break;

            case 'export':
                // Export result (for manual save or auto-save)
                console.log('Export event received, format:', msg.format);
                console.log('Export message keys:', Object.keys(msg));
                console.log('Export data available:', {
                    hasData: !!msg.data,
                    hasXml: !!msg.xml,
                    dataType: typeof msg.data,
                    xmlType: typeof msg.xml
                });

                // For xmlpng format, XML is embedded in the PNG data
                // We need to extract it or use msg.xml if available
                let xmlData = null;

                if (msg.xml && typeof msg.xml === 'string') {
                    // Direct XML available
                    xmlData = msg.xml;
                    console.log('Using msg.xml, length:', xmlData.length);
                } else if (msg.data && typeof msg.data === 'string') {
                    // Check if data is XML (starts with < or is base64)
                    if (msg.data.trim().startsWith('<')) {
                        xmlData = msg.data;
                        console.log('Using msg.data (XML string), length:', xmlData.length);
                    } else if (msg.format === 'xmlpng') {
                        // For xmlpng, we need to decode base64 and extract XML
                        // For now, request plain XML format instead
                        console.warn('Received xmlpng format but cannot extract XML, requesting plain xml...');
                        sendToDrawio('export', {format: 'xml'});
                        return;
                    }
                }

                if (xmlData && xmlData.length > 0) {
                    console.log('Valid XML export received, length:', xmlData.length);
                    currentDiagramXml = xmlData;
                    hasUnsavedChanges = true; // Mark as changed so saveDiagram will proceed
                    saveDiagram(true); // Force save since this is an explicit export request
                } else {
                    console.error('Export event missing xml data');
                    console.error('Full message:', msg);
                    updateStatus('Failed to export diagram data', true);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                }
                break;

            case 'exit':
                // User wants to exit
                if (hasUnsavedChanges) {
                    if (confirm('You have unsaved changes. Save before closing?')) {
                        saveDiagram();
                        setTimeout(() => {
                            window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                        }, 1000);
                    } else {
                        window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                    }
                } else {
                    window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                }
                break;
        }
    });

    // Save button click
    saveBtn.addEventListener('click', function() {
        console.log('Save button clicked, editorReady:', editorReady);
        if (editorReady) {
            // Always request fresh export from draw.io to get current state
            // Don't rely on autosave events as they may not fire reliably
            console.log('Requesting current diagram XML from draw.io...');
            updateStatus('Exporting diagram...');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
            sendToDrawio('export', {format: 'xmlpng'});
        } else {
            console.error('Cannot save - editor not ready');
            updateStatus('Editor not ready yet', true);
        }
    });

    // Warn about unsaved changes on page unload
    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // Clean up on unload
    window.addEventListener('unload', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });
})();
</script>
{% endblock %}
