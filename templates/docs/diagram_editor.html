{% extends "base.html" %}

{% block title %}Edit Diagram - {{ diagram.title }}{% endblock %}

{% block extra_head %}
<!-- Force browser to reload JavaScript by disabling cache -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h4><i class="fas fa-edit"></i> Editing: {{ diagram.title }} <small class="text-muted" style="font-size: 0.7em;">[Editor v2.6]</small></h4>
    <div>
        <button id="saveBtn" class="btn btn-success btn-sm" disabled>
            <i class="fas fa-save"></i> Save
        </button>
        <a href="{% url 'docs:diagram_detail' diagram.slug %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-times"></i> Close
        </a>
    </div>
</div>

<div class="alert alert-info alert-dismissible fade show mb-2" role="alert">
    <i class="fas fa-info-circle"></i> <strong>Draw.io Editor</strong> - Make your changes, then click Save. Auto-save every 60 seconds.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<!-- Draw.io iframe -->
<div class="card border-0">
    <div class="card-body p-0">
        <iframe
            id="drawio-iframe"
            src="https://embed.diagrams.net/?embed=1&proto=json&spin=1&saveAndExit=0&noSaveBtn=1&ui=kennedy&libraries=1&noExitBtn=1&autosave=1&xml=1&format=xml"
            style="width: 100%; height: 85vh; border: none;"
            allow="camera; microphone; clipboard-read; clipboard-write"
            sandbox="allow-same-origin allow-scripts allow-forms allow-modals allow-popups"
            allowfullscreen>
        </iframe>
    </div>
</div>

<!-- Store diagram XML in a script tag to avoid escaping issues -->
<script id="diagram-data" type="application/json">
{{ diagram.diagram_xml|default:""|safe }}
</script>

<div id="status" class="text-center text-muted small mt-2">
    Loading editor...
</div>
{% endblock %}

{% block extra_js %}
<script>
// Diagram Editor v2.6 - 2026-01-11 - Race condition fix for justSaved flag
console.log('ðŸ”„ Diagram Editor v2.6 loaded - race condition fix: justSaved set BEFORE fetch, threshold increased to 200 bytes');
(function() {
    const iframe = document.getElementById('drawio-iframe');
    const saveBtn = document.getElementById('saveBtn');
    const statusDiv = document.getElementById('status');
    const origin = 'https://embed.diagrams.net';

    // Get diagram XML from the script tag
    const diagramDataEl = document.getElementById('diagram-data');
    let currentDiagramXml = diagramDataEl ? diagramDataEl.textContent.trim() : '';
    let hasUnsavedChanges = false;
    let editorReady = false;
    let autoSaveInterval = null;
    let justSaved = false; // Track if we just saved to ignore immediate autosave events

    // Update status message
    function updateStatus(message, isError = false) {
        statusDiv.textContent = message;
        statusDiv.className = `text-center small mt-2 ${isError ? 'text-danger' : 'text-muted'}`;
    }

    // Send message to draw.io iframe
    function sendToDrawio(action, data = {}) {
        const message = JSON.stringify({action, ...data});
        console.log('Sending to draw.io:', action, data);
        iframe.contentWindow.postMessage(message, origin);
    }

    // Save diagram via AJAX
    function saveDiagram(forceSave = false, pngData = null) {
        console.log('saveDiagram() called, forceSave:', forceSave, 'hasUnsavedChanges:', hasUnsavedChanges, 'xml length:', currentDiagramXml.length, 'has PNG:', !!pngData);

        if (!forceSave && !hasUnsavedChanges) {
            console.log('No changes to save, aborting');
            updateStatus('No changes to save');
            return;
        }

        if (!currentDiagramXml || currentDiagramXml.length === 0) {
            console.error('No diagram XML to save');
            updateStatus('Error: No diagram data', true);
            return;
        }

        // CRITICAL FIX: Set justSaved flag IMMEDIATELY, before fetch starts
        // This prevents autosave events during the save process from setting hasUnsavedChanges
        justSaved = true;
        console.log('ðŸ”’ justSaved flag set to true at START of save (prevents race condition)');

        // Store the XML length at time of save for comparison
        const savedXmlLength = currentDiagramXml.length;

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        updateStatus('Saving...');
        console.log('Sending AJAX request to save diagram...');

        const payload = {
            diagram_xml: currentDiagramXml
        };

        // Include PNG export if available
        if (pngData) {
            payload.png_export = pngData;
            console.log('Including PNG export in save payload');
        }

        fetch('{% url "docs:diagram_save" diagram.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        })
        .then(response => {
            console.log('Save response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Save response data:', data);
            if (data.success) {
                hasUnsavedChanges = false;
                // justSaved already set at start of function
                updateStatus(`Saved successfully (v${data.version})`);
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved';
                console.log('âœ… Diagram saved successfully, version:', data.version);
                console.log('hasUnsavedChanges set to false, justSaved is true, save button disabled');

                // Important: Keep currentDiagramXml so next autosave won't trigger unsaved state
                // The currentDiagramXml already has the saved XML from the last autosave event
                console.log('Current XML preserved (length:', savedXmlLength, '), next autosave with minor changes will be ignored');

                // Re-enable button but show "Saved" for a moment
                setTimeout(() => {
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                    // Keep button disabled until actual changes are made
                    console.log('Button text reset to Save');
                }, 2000);

                // Auto-reset justSaved flag after 15 seconds (increased from 10)
                // This prevents autosave events from re-marking as unsaved right after save
                setTimeout(() => {
                    if (justSaved) {
                        justSaved = false;
                        console.log('ðŸ”“ justSaved flag auto-reset after 15 seconds');
                    }
                }, 15000);
            } else {
                // Save failed - reset justSaved flag
                justSaved = false;
                console.log('Save failed, justSaved flag reset');
                throw new Error(data.error || 'Save failed');
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            justSaved = false; // Reset flag on error
            updateStatus('Error: ' + error.message, true);
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
        });
    }

    // Check if iframe loaded
    iframe.addEventListener('load', function() {
        console.log('Draw.io iframe loaded successfully');
        updateStatus('Editor loading...');
    });

    iframe.addEventListener('error', function() {
        console.error('Draw.io iframe failed to load');
        updateStatus('Failed to load editor iframe', true);
    });

    // Timeout to detect if editor never loads
    const loadTimeout = setTimeout(() => {
        if (!editorReady) {
            updateStatus('Editor failed to load. Please refresh the page or check console for errors.', true);
            console.error('Draw.io editor timeout - no init message received after 15 seconds');
            console.log('Check browser console for CORS or CSP errors');
        }
    }, 15000); // 15 second timeout

    // Handle messages from draw.io
    window.addEventListener('message', function(evt) {
        if (evt.origin !== origin) return;

        let msg;
        try {
            msg = JSON.parse(evt.data);
        } catch (e) {
            return;
        }

        console.log('Draw.io message:', msg.event);

        switch (msg.event) {
            case 'init':
                clearTimeout(loadTimeout);
                editorReady = true;
                console.log('Editor ready, diagram XML length:', currentDiagramXml.length);
                updateStatus('Editor ready');

                // Configure draw.io to enable autosave events
                console.log('Configuring draw.io with autosave enabled...');
                sendToDrawio('configure', {
                    autosave: 1,
                    enableCustomLibraries: true
                });

                // Enable save button now that editor is ready
                saveBtn.disabled = false;
                console.log('Save button enabled (editor ready)');

                // Load existing diagram if available, otherwise load blank diagram
                if (currentDiagramXml && currentDiagramXml.length > 0) {
                    console.log('Loading existing diagram...');
                    sendToDrawio('load', {xml: currentDiagramXml, autosave: 1});
                    updateStatus('Loading diagram...');
                } else {
                    console.log('No existing diagram, loading blank canvas...');
                    // Load a blank diagram to start the editor
                    const blankDiagram = '<mxGraphModel><root><mxCell id="0"/><mxCell id="1" parent="0"/></root></mxGraphModel>';
                    sendToDrawio('load', {xml: blankDiagram, autosave: 1});
                    updateStatus('Ready to draw');
                }

                // Start auto-save polling (as fallback if events don't work)
                autoSaveInterval = setInterval(() => {
                    if (hasUnsavedChanges) {
                        console.log('Auto-save interval triggered');
                        sendToDrawio('export', {format: 'xmlpng'});
                    }
                }, 60000); // Auto-save every 60 seconds
                break;

            case 'configure':
                console.log('Configure event received - autosave should now be enabled');
                break;

            case 'load':
                console.log('Diagram loaded event received');
                updateStatus('Diagram loaded');
                break;

            case 'merge':
                // Merge event may contain XML
                console.log('Merge event received');
                if (msg.xml) {
                    console.log('Merge event has XML, length:', msg.xml.length);
                    if (msg.xml !== currentDiagramXml) {
                        currentDiagramXml = msg.xml;
                        hasUnsavedChanges = true;
                        saveBtn.disabled = false;
                        updateStatus('Unsaved changes (from merge)');
                    }
                }
                break;

            case 'autosave':
                // Diagram changed - this fires whenever user makes a change
                console.log('Autosave event received, xml length:', msg.xml ? msg.xml.length : 0, 'justSaved:', justSaved, 'hasUnsavedChanges:', hasUnsavedChanges);
                if (msg.xml) {
                    // If we just saved, ignore autosave events with minor changes
                    // (draw.io sends autosave events after PNG export with metadata changes)
                    if (justSaved) {
                        const lengthDiff = Math.abs(msg.xml.length - currentDiagramXml.length);
                        console.log('ðŸ”’ Just saved - checking autosave: length diff =', lengthDiff, 'bytes');

                        // INCREASED THRESHOLD: Ignore changes up to 200 bytes (was 100)
                        // PNG export often adds metadata that changes XML by 50-150 bytes
                        if (lengthDiff < 200) {
                            // Very minor change - probably just metadata from export
                            console.log('âœ“ Ignoring minor autosave after save (diff:', lengthDiff, 'bytes < 200 threshold)');
                            currentDiagramXml = msg.xml; // Update XML but don't mark as unsaved
                            // Don't reset justSaved flag - let timer handle it
                            return;
                        } else {
                            // Significant change - user continued editing
                            console.log('âœ— Significant change detected (diff:', lengthDiff, 'bytes >= 200 threshold) - user made new edits');
                            justSaved = false; // Reset flag and continue to mark as changed
                        }
                    }

                    // Only mark as changed if XML actually changed (not just initial load)
                    if (msg.xml !== currentDiagramXml) {
                        console.log('XML changed, marking as unsaved (prev:', currentDiagramXml.length, 'new:', msg.xml.length, ')');
                        currentDiagramXml = msg.xml;
                        hasUnsavedChanges = true;
                        saveBtn.disabled = false;
                        updateStatus('Unsaved changes');
                    } else {
                        console.log('XML unchanged (exact match), ignoring autosave event');
                    }
                } else {
                    console.warn('Autosave event missing xml data');
                }
                break;

            case 'save':
                // User clicked internal save (Ctrl+S or File > Save in draw.io)
                console.log('Save event received from draw.io');
                if (msg.xml) {
                    currentDiagramXml = msg.xml;
                    hasUnsavedChanges = true;
                    saveDiagram(true); // Force save
                } else {
                    console.warn('Save event missing xml data');
                }
                break;

            case 'export':
                // Export result (for manual save or auto-save)
                console.log('Export event received, format:', msg.format);
                console.log('Export data type:', typeof msg.data, 'length:', msg.data ? msg.data.length : 0);
                console.log('waitingForPngExport:', waitingForPngExport);

                // Handle PNG export (for preview generation)
                if (msg.format === 'png' || msg.format === 'xmlpng') {
                    if (waitingForPngExport) {
                        if (msg.data) {
                            console.log('âœ“ PNG export received, length:', msg.data.length, 'starts with:', msg.data.substring(0, 50));
                            pngExportData = msg.data; // Store base64 PNG data
                            waitingForPngExport = false;

                            // Now save with PNG data
                            console.log('Saving diagram with PNG export...');
                            saveDiagram(true, pngExportData);
                            return;
                        } else {
                            console.error('PNG export format received but no data!');
                            waitingForPngExport = false;
                            // Save without PNG
                            saveDiagram(true, null);
                            return;
                        }
                    } else {
                        console.log('PNG export received but not waiting for it (ignoring)');
                    }
                }

                // Handle XML export (legacy/fallback)
                console.log('Export message keys:', Object.keys(msg));
                console.log('Export data available:', {
                    hasData: !!msg.data,
                    hasXml: !!msg.xml,
                    dataType: typeof msg.data,
                    xmlType: typeof msg.xml
                });

                let xmlData = null;

                if (msg.xml && typeof msg.xml === 'string') {
                    // Direct XML available
                    xmlData = msg.xml;
                    console.log('Using msg.xml, length:', xmlData.length);
                } else if (msg.data && typeof msg.data === 'string') {
                    // Check if data is XML (starts with <)
                    if (msg.data.trim().startsWith('<')) {
                        xmlData = msg.data;
                        console.log('Using msg.data (XML string), length:', xmlData.length);
                    }
                }

                if (xmlData && xmlData.length > 0) {
                    console.log('Valid XML export received, length:', xmlData.length);
                    currentDiagramXml = xmlData;
                    hasUnsavedChanges = true;
                    saveDiagram(true);
                } else {
                    console.error('Export event missing xml data');
                    console.error('Full message:', msg);
                    updateStatus('Failed to export diagram data', true);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
                }
                break;

            case 'exit':
                // User wants to exit
                if (hasUnsavedChanges) {
                    if (confirm('You have unsaved changes. Save before closing?')) {
                        saveDiagram();
                        setTimeout(() => {
                            window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                        }, 1000);
                    } else {
                        window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                    }
                } else {
                    window.location.href = '{% url "docs:diagram_detail" diagram.slug %}';
                }
                break;
        }
    });

    // Track if we're waiting for PNG export
    let waitingForPngExport = false;
    let pngExportData = null;

    // Save button click
    saveBtn.addEventListener('click', function() {
        console.log('Save button clicked, editorReady:', editorReady);
        if (editorReady) {
            // If autosave has captured XML, request PNG export then save
            if (currentDiagramXml && currentDiagramXml.length > 100) {
                console.log('XML available (length:', currentDiagramXml.length, ')');
                console.log('Requesting PNG export for preview...');
                updateStatus('Generating preview...');
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';

                // Request PNG export
                waitingForPngExport = true;
                pngExportData = null;
                sendToDrawio('export', {format: 'png'});

                // Fallback: Save without PNG after 3 seconds if export fails
                setTimeout(() => {
                    if (waitingForPngExport) {
                        console.log('PNG export timeout, saving without preview');
                        waitingForPngExport = false;
                        saveDiagram(true, null);
                    }
                }, 3000);
            } else {
                // No XML captured yet - this shouldn't happen
                console.error('No XML cached - cannot save');
                updateStatus('Error: No diagram data', true);
            }
        } else {
            console.error('Cannot save - editor not ready');
            updateStatus('Editor not ready yet', true);
        }
    });

    // Warn about unsaved changes on page unload
    window.addEventListener('beforeunload', function(e) {
        console.log('beforeunload event - hasUnsavedChanges:', hasUnsavedChanges, 'justSaved:', justSaved);
        if (hasUnsavedChanges) {
            console.warn('Showing unsaved changes warning');
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        } else {
            console.log('No unsaved changes, allowing navigation');
        }
    });

    // Clean up on unload
    window.addEventListener('unload', function() {
        if (autoSaveInterval) {
            clearInterval(autoSaveInterval);
        }
    });
})();
</script>
{% endblock %}
